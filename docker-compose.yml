version: "3.8"

services:
  kidpulse:
    # image: ghcr.io/clucraft/kidpulse:latest
    build: .  # Build locally to get latest changes
    container_name: kidpulse
    restart: unless-stopped
    environment:
      # Playground credentials
      - PLAYGROUND_EMAIL=${PLAYGROUND_EMAIL}
      - PLAYGROUND_PASSWORD=${PLAYGROUND_PASSWORD}
      - PLAYGROUND_ORGANIZATION=${PLAYGROUND_ORGANIZATION}

      # NTFY configuration
      - NTFY_ENABLED=${NTFY_ENABLED:-true}
      - NTFY_SERVER=${NTFY_SERVER:-https://ntfy.sh}
      - NTFY_TOPIC=${NTFY_TOPIC:-kidpulse}

      # Telegram configuration
      - TELEGRAM_ENABLED=${TELEGRAM_ENABLED:-false}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID:-}

      # Schedule settings
      - SUMMARY_TIME=${SUMMARY_TIME:-17:00}
      - SCRAPE_INTERVAL=${SCRAPE_INTERVAL:-30}
      - TZ=${TZ:-America/New_York}

      # Run immediately on startup (set to true for testing)
      - RUN_ON_STARTUP=${RUN_ON_STARTUP:-false}

      # Debug mode
      - DEBUG=${DEBUG:-false}

      # Web UI port
      - WEB_PORT=${WEB_PORT:-8080}

      # Authentication
      - AUTH_ENABLED=${AUTH_ENABLED:-false}
      - AUTH_USERNAME=${AUTH_USERNAME:-admin}
      - AUTH_PASSWORD=${AUTH_PASSWORD:-}
      - AUTH_SECRET=${AUTH_SECRET:-}
      - BASE_URL=${BASE_URL:-http://localhost:8080}
    ports:
      - "${WEB_PORT:-8080}:8080"
    volumes:
      # Persist session data to avoid re-login
      - ./session_data:/app/session_data
    # Optional: health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/status"]
      interval: 2m
      timeout: 10s
      retries: 3
      start_period: 30s
